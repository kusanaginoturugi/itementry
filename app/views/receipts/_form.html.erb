<%= form_with(model: receipt, class: "card shadow-sm", data: { controller: "receipt-form" }) do |form| %>
  <div class="card-body">
  <% if receipt.errors.any? %>
    <div class="alert alert-danger">
      <h2 class="h6 fw-semibold"><%= "#{receipt.errors.count}件のエラーにより保存できませんでした。" %></h2>

      <ul class="mb-0">
        <% receipt.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

    <div class="row gy-3 align-items-end">
      <div class="col-md-6">
        <%= form.label :name, "レシート名", class: "form-label" %>
        <%= form.text_field :name, class: "form-control" %>
      </div>
      <div class="col-md-3">
        <label class="form-label text-muted">点数合計</label>
        <div class="form-control bg-light fw-bold" data-receipt-form-target="totalCount">0</div>
      </div>
      <div class="col-md-3">
        <label class="form-label text-muted">金額合計</label>
        <div class="form-control bg-light fw-bold" data-receipt-form-target="totalValue">0</div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h5 mb-0">レシート明細</h2>
      <%= link_to "明細を追加", "#", class: "btn btn-outline-primary btn-sm", data: { action: "receipt-form#addDetail" } %>
    </div>

    <div data-receipt-form-target="details">
      <%= form.fields_for :receipt_details do |detail_form| %>
        <%= render "receipt_detail_fields", f: detail_form %>
      <% end %>
    </div>

    <template data-receipt-form-target="template">
      <%= form.fields_for :receipt_details, ReceiptDetail.new, child_index: "NEW_RECORD" do |detail_form| %>
        <%= render "receipt_detail_fields", f: detail_form %>
      <% end %>
    </template>

    <div class="d-flex gap-2 mt-3">
      <%= form.submit "保存する", class: "btn btn-primary" %>
      <%= link_to "戻る", receipt.persisted? ? receipt : receipts_path, class: "btn btn-outline-secondary" %>
    </div>

    <% if @items.present? %>
      <div class="card mt-3">
        <div class="card-header py-2">
          <span class="fw-semibold">商品コード一覧</span>
        </div>
        <div class="card-body">
          <div class="row g-2">
            <% @items.each do |item| %>
              <% tone = case item.item_code.to_s[0]&.upcase
                when '0' then 'rgba(248,249,250,0.9)'
                when '1' then 'rgba(240,245,255,0.9)'
                when '2' then 'rgba(240,255,245,0.9)'
                when '3' then 'rgba(255,245,240,0.9)'
                when '4' then 'rgba(245,240,255,0.9)'
                when '5' then 'rgba(255,250,240,0.9)'
                when '6' then 'rgba(240,248,255,0.9)'
                when '7' then 'rgba(245,255,250,0.9)'
                when '8' then 'rgba(250,255,240,0.9)'
                when '9' then 'rgba(252,248,255,0.9)'
                else 'rgba(248,249,250,0.9)'
              end %>
              <div class="col-lg-2 col-md-3 col-sm-4">
                <div class="border rounded p-2 h-100" style="background-color: <%= tone %>;">
                  <div class="text-monospace fw-bold mb-1"><%= item.item_code %></div>
                  <div class="small text-truncate"><%= item.name %></div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
