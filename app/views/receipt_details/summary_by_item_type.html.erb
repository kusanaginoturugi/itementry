<% content_for :title, "商品種類別明細集計" %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">商品種類別明細集計</h1>
  <div class="btn-group">
    <% unless request.format.pdf? %>
      <%= form_with url: summary_by_item_type_receipt_details_path, method: :get, local: true, class: "d-flex gap-2 flex-wrap pdf-hide" do |f| %>
        <div class="d-flex align-items-center gap-2">
          <%= f.label :book_id, "帳票", class: "form-label mb-0 align-self-center" %>
          <%= f.select :book_id,
                options_from_collection_for_select(@books, :id, :title, params.key?(:book_id) ? params[:book_id] : @selected_book_id),
                { include_blank: "すべて" },
                class: "form-select form-select-sm" %>
        </div>
        <div class="d-flex align-items-center gap-2">
          <%= f.label :item_type, "商品種類", class: "form-label mb-0 align-self-center" %>
          <%= f.select :item_type,
                options_for_select([["すべて", ""]] + item_type_options, params[:item_type].presence || @selected_item_type),
                {},
                class: "form-select form-select-sm" %>
        </div>
        <%= f.submit "適用", class: "btn btn-outline-secondary btn-sm" %>
      <% end %>
      <%= link_to "PDF出力", summary_by_item_type_receipt_details_path(request.query_parameters.merge(format: :pdf)), class: "btn btn-outline-primary btn-sm pdf-hide" %>
    <% else %>
      <div class="d-flex gap-3">
        <% if @selected_book_id.present? %>
          <% selected_book = @books.find { |b| b.id == @selected_book_id.to_i } %>
          <span><strong>帳票:</strong> <%= selected_book&.title || "すべて" %></span>
        <% else %>
          <span><strong>帳票:</strong> すべて</span>
        <% end %>
        <span>
          <strong>商品種類:</strong>
          <%= @selected_item_type.present? ? item_type_label(@selected_item_type) : "すべて" %>
        </span>
      </div>
    <% end %>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <% if request.format.pdf? && defined?(wicked_pdf_stylesheet_link_tag) %>
      <%= wicked_pdf_stylesheet_link_tag "pdf" %>
    <% end %>
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">
            <%= link_to "商品コード", summary_by_item_type_receipt_details_path(request.query_parameters.merge(sort: "item_code", direction: toggle_direction_for("item_code"))), class: "text-decoration-none" %>
          </th>
          <th scope="col">
            <%= link_to "商品名", summary_by_item_type_receipt_details_path(request.query_parameters.merge(sort: "item_name", direction: toggle_direction_for("item_name"))), class: "text-decoration-none" %>
          </th>
          <th scope="col" class="text-end">
            <%= link_to "合計個数", summary_by_item_type_receipt_details_path(request.query_parameters.merge(sort: "total_count", direction: toggle_direction_for("total_count"))), class: "text-decoration-none" %>
          </th>
          <th scope="col" class="text-end">
            <%= link_to "合計金額", summary_by_item_type_receipt_details_path(request.query_parameters.merge(sort: "total_value", direction: toggle_direction_for("total_value"))), class: "text-decoration-none" %>
          </th>
          <th scope="col" class="text-end">
            <%= link_to "還付単価", summary_by_item_type_receipt_details_path(request.query_parameters.merge(sort: "total_refund", direction: toggle_direction_for("total_refund"))), class: "text-decoration-none" %>
          </th>
          <th scope="col" class="text-end">
            <%= link_to "還付合計", summary_by_item_type_receipt_details_path(request.query_parameters.merge(sort: "total_sum_refund", direction: toggle_direction_for("total_sum_refund"))), class: "text-decoration-none" %>
          </th>
          <th scope="col" class="text-end">
            <%= link_to "支払合計", summary_by_item_type_receipt_details_path(request.query_parameters.merge(sort: "total_sum_payment", direction: toggle_direction_for("total_sum_payment"))), class: "text-decoration-none" %>
          </th>
        </tr>
        <tr class="table-secondary">
          <th>合計</th>
          <th></th>
          <th class="text-end"><%= @summaries.sum(&:total_count) %></th>
          <th class="text-end"><%= number_with_delimiter(@summaries.sum(&:total_value)) %></th>
          <th class="text-end"><%= number_with_delimiter(@summaries.sum(&:total_refund)) %></th>
          <th class="text-end"><%= number_with_delimiter(@summaries.sum(&:total_sum_refund)) %></th>
          <th class="text-end"><%= number_with_delimiter(@summaries.sum(&:total_sum_payment)) %></th>
        </tr>
      </thead>
      <tbody>
        <% @summaries.each do |row| %>
          <% tone_style = item_code_style(row.item_code) %>
          <tr>
            <td class="text-monospace" style="<%= tone_style %>"><%= row.item_code %></td>
            <td style="<%= tone_style %>"><%= row.item_name %></td>
            <td class="text-end" style="<%= tone_style %>"><%= row.total_count %></td>
            <td class="text-end" style="<%= tone_style %>"><%= number_with_delimiter(row.total_value) %></td>
            <td class="text-end" style="<%= tone_style %>"><%= number_with_delimiter(row.total_refund) %></td>
            <td class="text-end" style="<%= tone_style %>"><%= number_with_delimiter(row.total_sum_refund) %></td>
            <td class="text-end" style="<%= tone_style %>"><%= number_with_delimiter(row.total_sum_payment) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
