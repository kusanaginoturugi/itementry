<% content_for :title, "レシート明細集計" %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h4 mb-0">レシート明細集計</h1>
  <div class="btn-group">
    <%= form_with url: summary_receipt_details_path, method: :get, local: true, class: "d-flex gap-2" do |f| %>
      <%= f.label :book_id, "帳票", class: "form-label mb-0 align-self-center" %>
      <%= f.select :book_id,
            options_from_collection_for_select(@books, :id, :title, params[:book_id].presence || @current_book&.id),
            { include_blank: "すべて" },
            class: "form-select form-select-sm" %>
      <%= f.submit "適用", class: "btn btn-outline-secondary btn-sm" %>
    <% end %>
    <%= link_to "CSV出力", summary_receipt_details_path(request.query_parameters.merge(format: :csv)), class: "btn btn-outline-primary btn-sm" %>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <table class="table table-hover mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th scope="col">
            <%= link_to "商品コード", summary_receipt_details_path(request.query_parameters.merge(sort: "item_code", direction: toggle_direction_for("item_code"))), class: "text-decoration-none" %>
          </th>
          <th scope="col">
            <%= link_to "商品名", summary_receipt_details_path(request.query_parameters.merge(sort: "item_name", direction: toggle_direction_for("item_name"))), class: "text-decoration-none" %>
          </th>
          <th scope="col" class="text-end">
            <%= link_to "合計個数", summary_receipt_details_path(request.query_parameters.merge(sort: "total_count", direction: toggle_direction_for("total_count"))), class: "text-decoration-none" %>
          </th>
          <th scope="col" class="text-end">
            <%= link_to "合計金額", summary_receipt_details_path(request.query_parameters.merge(sort: "total_value", direction: toggle_direction_for("total_value"))), class: "text-decoration-none" %>
          </th>
        </tr>
        <tr class="table-secondary">
          <th>合計</th>
          <th></th>
          <th class="text-end"><%= @summaries.sum(&:total_count) %></th>
          <th class="text-end"><%= number_with_delimiter(@summaries.sum(&:total_value)) %></th>
        </tr>
      </thead>
      <tbody>
        <% @summaries.each do |row| %>
          <tr>
            <td class="text-monospace"><%= row.item_code %></td>
            <td><%= row.item_name %></td>
            <td class="text-end"><%= row.total_count %></td>
            <td class="text-end"><%= number_with_delimiter(row.total_value) %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
